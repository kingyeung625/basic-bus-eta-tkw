<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>個人化巴士儀表板 (最終版)</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f0f2f5;
            color: #333;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
        }
        #app-wrapper {
            width: 100%;
            max-width: 500px;
        }
        .container {
            background: #fff;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            overflow: hidden;
        }
        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            border-bottom: 1px solid #eee;
            padding-bottom: 15px;
        }
        .panel-header h1 {
            color: #d71f28; /* KMB Red */
            margin: 0;
            font-size: 1.3em;
        }
        .toggle-button {
            background-color: #f0f0f0;
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
            color: #555;
            transition: background-color 0.2s;
        }
        .toggle-button:hover {
            background-color: #e0e0e0;
        }
        .panel-body {
            max-height: 1000px;
            transition: max-height 0.5s ease-in-out, visibility 0.5s;
            visibility: visible;
            overflow: hidden;
        }
        .panel-body.collapsed {
            max-height: 0;
            visibility: hidden;
        }
        .eta-list { list-style-type: none; padding: 0; margin: 0; }
        .eta-item { display: flex; justify-content: space-between; align-items: center; padding: 18px 10px; border-bottom: 1px solid #f0f0f0; transition: background-color 0.3s; }
        .eta-item:last-child { border-bottom: none; }
        
        .eta-item.suggested {
            background-color: #e6ffed;
            border-left: 5px solid #008000;
            padding-left: 5px;
        }
        .eta-item.suggested .destination::after {
            content: ' (建議班次)';
            color: #008000;
            font-size: 0.8em;
            font-weight: bold;
            margin-left: 8px;
        }

        .route-info { display: flex; align-items: center; }
        .route-number { font-size: 1.8em; font-weight: bold; color: #fff; background-color: #d71f28; padding: 6px 15px; border-radius: 8px; margin-right: 15px; min-width: 50px; text-align: center; }
        .destination { font-size: 1.1em; font-weight: 500; }
        .arrival-time { font-size: 1.4em; font-weight: bold; color: #008000; text-align: right; min-width: 100px; }
        .status-message { text-align: center; font-size: 1em; color: #888; padding: 20px 0; }
        .last-updated { text-align: center; font-size: 0.8em; color: #aaa; margin-top: 20px; }
        .holiday-banner {
            background-color: #008000;
            color: white;
            text-align: center;
            padding: 15px;
            border-radius: 12px;
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 20px;
            display: none;
        }
    </style>
</head>
<body>
    <div id="app-wrapper">
        <div id="holiday-message" class="holiday-banner">你放假了！</div>
        <div id="panel-61m" class="container">
            <div class="panel-header"> <h1 id="station-name-61m"></h1> <button class="toggle-button" data-target="panel-body-61m">收合</button> </div>
            <div id="panel-body-61m" class="panel-body"> <ul id="eta-list-61m" class="eta-list"></ul> <div id="status-message-61m" class="status-message"></div> <div id="last-updated-61m" class="last-updated"></div> </div>
        </div>
        <div id="panel-68m" class="container">
            <div class="panel-header"> <h1 id="station-name-68m"></h1> <button class="toggle-button" data-target="panel-body-68m">收合</button> </div>
            <div id="panel-body-68m" class="panel-body"> <ul id="eta-list-68m" class="eta-list"></ul> <div id="status-message-68m" class="status-message"></div> <div id="last-updated-68m" class="last-updated"></div> </div>
        </div>
    </div>

    <script>
        // --- 智能巴士儀表板 (最終版) ---
        
        // --- 1. 全局設定 ---
        const WORK_ARRIVAL_TIME = "10:30";
        const QUERIES = [
            {
                id: '61m',
                stopId: '10860B611840CF22',
                stationName: '荃景圍天橋 (TW377)',
                routes: [{ route: '61M',  dir: 'O' }],
                elementIds: { stationName: 'station-name-61m', etaList: 'eta-list-61m', status: 'status-message-61m', updated: 'last-updated-61m' },
                isWorkBus: true,
                workDays: [1, 2, 5], // 星期一, 二, 五
                totalTravelMinutes: 15 // 5分鐘步行 + 10分鐘車程
            },
            {
                id: '68m',
                stopId: 'A68A34F71D94FF13',
                stationName: '荃景圍天橋 (TW153)',
                routes: [{ route: '68M',  dir: 'O' }],
                elementIds: { stationName: 'station-name-68m', etaList: 'eta-list-68m', status: 'status-message-68m', updated: 'last-updated-68m' },
                isWorkBus: true,
                workDays: [6], // 星期六
                totalTravelMinutes: 25 // 7分鐘步行 + 18分鐘車程
            }
        ];
        
        // --- 2. 核心功能函式 ---
        async function fetchAndDisplayEta(config) {
            const stationNameElement = document.getElementById(config.elementIds.stationName);
            const etaListElement = document.getElementById(config.elementIds.etaList);
            const statusMessageElement = document.getElementById(config.elementIds.status);
            const lastUpdatedElement = document.getElementById(config.elementIds.updated);
            
            stationNameElement.textContent = config.stationName;
            statusMessageElement.textContent = '正在更新...';

            try {
                const promises = config.routes.map(r => {
                    const url = `https://data.etabus.gov.hk/v1/transport/kmb/eta/${config.stopId}/${r.route}/1`;
                    return fetch(url).then(response => response.ok ? response.json() : null).then(data => {
                        if (!data) return [];
                        return data.data.filter(eta => eta.dir === r.dir);
                    });
                });

                const resultsByRoute = await Promise.all(promises);
                let allEtas = resultsByRoute.flat();

                etaListElement.innerHTML = '';
                statusMessageElement.textContent = '';

                if (allEtas.length > 0) {
                    allEtas.sort((a, b) => new Date(a.eta) - new Date(b.eta));
                    const now = new Date();
                    const today = now.getDay();

                    if (config.isWorkBus && config.workDays.includes(today)) {
                        const [hours, minutes] = WORK_ARRIVAL_TIME.split(':');
                        const deadline = new Date(now);
                        deadline.setHours(hours, minutes, 0, 0);
                        const mustDepartByTime = new Date(deadline.getTime() - config.totalTravelMinutes * 60 * 1000);
                        
                        if (now < mustDepartByTime) {
                            for (let i = allEtas.length - 1; i >= 0; i--) {
                                const arrivalTime = new Date(allEtas[i].eta);
                                if (arrivalTime <= mustDepartByTime) {
                                    allEtas[i].isSuggested = true;
                                    break;
                                }
                            }
                        }
                    }

                    allEtas.forEach(etaEntry => {
                        const arrival = new Date(etaEntry.eta);
                        const diffMinutes = Math.floor((arrival - new Date()) / (1000 * 60));
                        const timeDisplay = diffMinutes < 1 ? '即將到達' : `${diffMinutes} 分鐘`;
                        const suggestedClass = etaEntry.isSuggested ? ' suggested' : '';
                        const remarkText = etaEntry.rmk_tc ? `<div class="remark">${etaEntry.rmk_tc}</div>` : '';
                        const listItemHTML = `<li class="eta-item${suggestedClass}"><div class="route-info"><span class="route-number">${etaEntry.route}</span><div><div class="destination">往 ${etaEntry.dest_tc}</div>${remarkText}</div></div><span class="arrival-time">${timeDisplay}</span></li>`;
                        etaListElement.innerHTML += listItemHTML;
                    });
                } else {
                    statusMessageElement.textContent = '暫無到站預報';
                }

                lastUpdatedElement.textContent = `最後更新: ${new Date().toLocaleTimeString('zh-HK')}`;
            } catch (error) {
                console.error(`更新 ${config.stationName} 時出錯:`, error);
                statusMessageElement.textContent = '更新失敗，請檢查網絡連線。';
            }
        }
        
        // --- 3. 初始化與事件監聽 ---
        document.addEventListener('DOMContentLoaded', () => {
            const appWrapper = document.getElementById('app-wrapper');
            const holidayMessage = document.getElementById('holiday-message');
            const panel61m = document.getElementById('panel-61m');
            const panel68m = document.getElementById('panel-68m');
            const today = new Date().getDay();

            switch (today) {
                case 6: appWrapper.insertBefore(panel68m, panel61m); document.getElementById('panel-body-61m').classList.add('collapsed'); break;
                case 3: case 4: case 0: holidayMessage.style.display = 'block'; document.getElementById('panel-body-61m').classList.add('collapsed'); document.getElementById('panel-body-68m').classList.add('collapsed'); break;
                case 1: case 2: case 5: default: document.getElementById('panel-body-68m').classList.add('collapsed'); break;
            }
            
            document.querySelectorAll('.toggle-button').forEach(button => {
                const targetId = button.getAttribute('data-target');
                const targetBody = document.getElementById(targetId);
                if (targetBody.classList.contains('collapsed')) {
                    button.textContent = '展開';
                }
                button.addEventListener('click', () => {
                    const isCollapsed = targetBody.classList.toggle('collapsed');
                    button.textContent = isCollapsed ? '展開' : '收合';
                });
            });
            
            QUERIES.forEach(queryConfig => {
                fetchAndDisplayEta(queryConfig);
                setInterval(() => fetchAndDisplayEta(queryConfig), 15000);
            });
        });
    </script>
</body>
</html>