<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>個人化巴士儀表板 (最終版)</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f0f2f5;
            color: #333;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
        }
        #app-wrapper {
            width: 100%;
            max-width: 500px;
        }
        .container {
            background: #fff;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            overflow: hidden;
        }
        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            border-bottom: 1px solid #eee;
            padding-bottom: 15px;
        }
        .panel-header h1 {
            color: #d71f28; /* KMB Red */
            margin: 0;
            font-size: 1.3em;
        }
        .toggle-button {
            background-color: #f0f0f0;
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
            color: #555;
            transition: background-color 0.2s;
        }
        .toggle-button:hover {
            background-color: #e0e0e0;
        }
        .panel-body {
            max-height: 1000px;
            transition: max-height 0.5s ease-in-out, visibility 0.5s;
            visibility: visible;
            overflow: hidden;
        }
        .panel-body.collapsed {
            max-height: 0;
            visibility: hidden;
        }
        .eta-list { list-style-type: none; padding: 0; margin: 0; }
        .eta-item { display: flex; justify-content: space-between; align-items: center; padding: 18px 10px; border-bottom: 1px solid #f0f0f0; transition: background-color 0.3s; }
        .eta-item:last-child { border-bottom: none; }
        
        .eta-item.suggested {
            background-color: #e6ffed;
            border-left: 5px solid #008000;
            padding-left: 5px;
        }
        .eta-item.suggested .destination::after {
            content: ' (建議班次)';
            color: #008000;
            font-size: 0.8em;
            font-weight: bold;
            margin-left: 8px;
        }

        .route-info { display: flex; align-items: center; }
        .route-number { font-size: 1.8em; font-weight: bold; color: #fff; background-color: #d71f28; padding: 6px 15px; border-radius: 8px; margin-right: 15px; min-width: 50px; text-align: center; }
        .destination { font-size: 1.1em; font-weight: 500; }
        .arrival-time { font-size: 1.4em; font-weight: bold; color: #008000; text-align: right; min-width: 100px; }
        .status-message { text-align: center; font-size: 1em; color: #888; padding: 20px 0; }
        .last-updated { text-align: center; font-size: 0.8em; color: #aaa; margin-top: 20px; }
        .holiday-banner {
            background-color: #008000;
            color: white;
            text-align: center;
            padding: 15px;
            border-radius: 12px;
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 20px;
            display: none;
        }
    </style>
</head>
<body>
    <div id="app-wrapper">
        <div id="holiday-message" class="holiday-banner">你放假了！</div>
        <div id="panel-A" class="container">
            <div class="panel-header"> <h1 id="station-name-A"></h1> <button class="toggle-button" data-target="panel-body-A">收合</button> </div>
            <div id="panel-body-A" class="panel-body"> <ul id="eta-list-A" class="eta-list"></ul> <div id="status-message-A" class="status-message"></div> <div id="last-updated-A" class="last-updated"></div> </div>
        </div>
        <div id="panel-B" class="container">
            <div class="panel-header"> <h1 id="station-name-B"></h1> <button class="toggle-button" data-target="panel-body-B">收合</button> </div>
            <div id="panel-body-B" class="panel-body"> <ul id="eta-list-B" class="eta-list"></ul> <div id="status-message-B" class="status-message"></div> <div id="last-updated-B" class="last-updated"></div> </div>
        </div>
    </div>

    <script>
        // --- 智能巴士儀表板 (最終版) ---
        
        const WORK_ARRIVAL_TIME = "10:30";
        const QUERIES = [
            {
                id: 'A',
                panelElementId: 'panel-A',
                stopId: '10860B611840CF22', // 荃景圍天橋 (TW377)
                stationName: '荃景圍天橋 (TW377)',
                routes: [
                    { route: '61M',  dir: 'O', isWorkBus: true, workDays: [1, 2, 5], totalTravelMinutes: 17 },
                    { route: '58M',  dir: 'O' },
                    { route: '67M',  dir: 'O' },
                    { route: '69M',  dir: 'O' }
                ],
                elementIds: { stationName: 'station-name-A', etaList: 'eta-list-A', status: 'status-message-A', updated: 'last-updated-A' }
            },
            {
                id: 'B',
                panelElementId: 'panel-B',
                stopId: 'A68A34F71D94FF13', // 荃景圍天橋 (TW153)
                stationName: '荃景圍天橋 (TW153)',
                // *** 【最新更新】已隱藏 265M 及 269M ***
                routes: [
                    { route: '68M',  dir: 'O', isWorkBus: true, workDays: [6], totalTravelMinutes: 28 } // 往元朗(西) 方向
                ],
                elementIds: { stationName: 'station-name-B', etaList: 'eta-list-B', status: 'status-message-B', updated: 'last-updated-B' }
            }
        ];
        
        async function fetchAndDisplayEta(config) {
            const stationNameElement = document.getElementById(config.elementIds.stationName);
            const etaListElement = document.getElementById(config.elementIds.etaList);
            const statusMessageElement = document.getElementById(config.elementIds.status);
            const lastUpdatedElement = document.getElementById(config.elementIds.updated);
            
            stationNameElement.textContent = config.stationName;
            statusMessageElement.textContent = '正在更新...';

            try {
                const promises = config.routes.map(r => {
                    const url = `https://data.etabus.gov.hk/v1/transport/kmb/eta/${config.stopId}/${r.route}/1`;
                    return fetch(url).then(response => response.ok ? response.json() : null).then(data => {
                        if (!data) return [];
                        return data.data.filter(eta => eta.dir === r.dir).map(eta => ({...eta, commuteRule: r}));
                    });
                });

                const resultsByRoute = await Promise.all(promises);
                let allEtas = resultsByRoute.flat();

                etaListElement.innerHTML = '';
                statusMessageElement.textContent = '';

                if (allEtas.length > 0) {
                    allEtas.sort((a, b) => new Date(a.eta) - new Date(b.eta));
                    const now = new Date();
                    const today = now.getDay();

                    allEtas.forEach(eta => {
                        const rule = eta.commuteRule;
                        if (rule && rule.isWorkBus && rule.workDays.includes(today)) {
                            const [hours, minutes] = WORK_ARRIVAL_TIME.split(':');
                            const deadline = new Date(now);
                            deadline.setHours(hours, minutes, 0, 0);
                            const mustDepartByTime = new Date(deadline.getTime() - rule.totalTravelMinutes * 60 * 1000);
                            
                            if (now < mustDepartByTime) {
                                const potentialBuses = allEtas.filter(e => e.route === rule.route && new Date(e.eta) <= mustDepartByTime);
                                if (potentialBuses.length > 0) {
                                    const latestBus = potentialBuses[potentialBuses.length - 1];
                                    if(eta === latestBus) eta.isSuggested = true;
                                }
                            }
                        }
                    });

                    allEtas.forEach(etaEntry => {
                        const arrival = new Date(etaEntry.eta);
                        const diffMinutes = Math.floor((arrival - new Date()) / (1000 * 60));
                        const timeDisplay = diffMinutes < 1 ? '即將到達' : `${diffMinutes} 分鐘`;
                        const suggestedClass = etaEntry.isSuggested ? ' suggested' : '';
                        const remarkText = etaEntry.rmk_tc ? `<div class="remark">${etaEntry.rmk_tc}</div>` : '';
                        const listItemHTML = `<li class="eta-item${suggestedClass}"><div class="route-info"><span class="route-number">${etaEntry.route}</span><div><div class="destination">往 ${etaEntry.dest_tc}</div>${remarkText}</div></div><span class="arrival-time">${timeDisplay}</span></li>`;
                        etaListElement.innerHTML += listItemHTML;
                    });
                } else {
                    statusMessageElement.textContent = '暫無到站預報';
                }

                lastUpdatedElement.textContent = `最後更新: ${new Date().toLocaleTimeString('zh-HK')}`;
            } catch (error) {
                console.error(`更新 ${config.stationName} 時出錯:`, error);
                statusMessageElement.textContent = '更新失敗，請檢查網絡連線。';
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            const appWrapper = document.getElementById('app-wrapper');
            const holidayMessage = document.getElementById('holiday-message');
            const panelA = document.getElementById('panel-A');
            const panelB = document.getElementById('panel-B');
            const today = new Date().getDay();

            switch (today) {
                case 6: // 星期六
                    appWrapper.insertBefore(panelB, panelA);
                    document.getElementById('panel-body-A').classList.add('collapsed');
                    break;
                case 3: case 4: case 0: // 星期三, 四, 日
                    holidayMessage.style.display = 'block';
                    document.getElementById('panel-body-A').classList.add('collapsed');
                    document.getElementById('panel-body-B').classList.add('collapsed');
                    break;
                case 1: case 2: case 5: // 星期一, 二, 五
                default:
                    document.getElementById('panel-body-B').classList.add('collapsed');
                    break;
            }
            
            document.querySelectorAll('.toggle-button').forEach(button => {
                const targetId = button.getAttribute('data-target');
                const targetBody = document.getElementById(targetId);
                if (targetBody.classList.contains('collapsed')) {
                    button.textContent = '展開';
                }
                button.addEventListener('click', () => {
                    const isCollapsed = targetBody.classList.toggle('collapsed');
                    button.textContent = isCollapsed ? '展開' : '收合';
                });
            });
            
            QUERIES.forEach(queryConfig => {
                fetchAndDisplayEta(queryConfig);
                setInterval(() => fetchAndDisplayEta(queryConfig), 15000);
            });
        });
    </script>
</body>
</html>
